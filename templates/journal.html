{% extends "template/base-login.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    .journal-textarea {
        min-height: 150px;
        transition: min-height 0.3s ease;
    }

    .journal-textarea:focus {
        min-height: 200px;
    }

    .journal-card {
        transition: all 0.3s ease;
    }

    .journal-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .emoji-indicator {
        font-size: 2rem;
        line-height: 1;
    }
</style>

<!--Konten utama-->
<!-- Main Container -->
<div class="container mx-auto p-4 md:px-4 md:py-8 w-full">
    <div class="flex flex-col md:flex-row gap-12 w-full">
        <!-- Left: Journal List -->
        <div class="overflow-hidden md:w-2/5 flex flex-col bg-white shadow-md rounded-lg">
            <div class="p-4 border-b">
                <h2 class="text-xl font-medium text-gray-800">Journal Archive</h2>
                <p class="text-gray-500 text-sm">Explore your past journal entries!</p>
            </div>
            <div class="overflow-y-auto max-h-[70vh] scrollbar-hide">
                <ul class="divide-y divide-gray-200" id="journal-list">
                    {% if journal_entries %}
                    {% for entry in journal_entries %}
                    <li>
                        <button
                            class="w-full text-left px-4 py-2 hover:bg-gray-100 transition journal-item {% if loop.first %}bg-gray-50{% endif %}"
                            data-id="{{ entry.id }}">
                            <div
                                class="flex items-center justify-between transition-all duration-200 hover:translate-x-1">
                                <div>
                                    <div class="font-medium text-gray-700">
                                        {% if entry.rating == 1 %}Awful{% elif entry.rating == 2 %}Meh{% elif
                                        entry.rating == 3
                                        %}Okay{% elif entry.rating == 4 %}Nice{% elif entry.rating == 5 %}Excellent{%
                                        endif %}
                                    </div>
                                    <div class="text-sm text-gray-500">{{ entry.day_of_week }}, {{ entry.formatted_date
                                        }}</div>
                                </div>
                                <div class="text-2xl">
                                    {% if entry.rating == 1 %}ğŸ˜{% elif entry.rating == 2 %}â˜¹ï¸{% elif entry.rating == 3
                                    %}ğŸ˜{% elif entry.rating == 4 %}ğŸ™‚{% elif entry.rating == 5 %}ğŸ˜Š{% endif %}
                                </div>
                            </div>
                        </button>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li class="text-gray-500 text-center py-4">No journal entries yet. Start writing your first one!
                        âœï¸ğŸ˜Š</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Right: Journal Entry -->
        <div class="bg-white shadow-md rounded-lg w-full mx-auto">
            <!-- Header with subtle border instead of dark background -->
            <div class="p-4 border-b flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-medium text-gray-800">Journal Entry</h2>
                    <p class="text-gray-500 text-sm">Check out your daily journal, and feel free to edit if needed!</p>
                </div>
                <div class="flex flex-wrap gap-2 justify-center md:justify-start" id="action-buttons">
                    <button id="save-button"
                        class="w-full md:w-auto bg-gray-100 text-gray-700 px-4 py-1.5 rounded-md border border-gray-200 hover:bg-gray-200 transition text-sm font-medium">
                        Save
                    </button>
                    <button id="delete-button"
                        class="w-full md:w-auto text-gray-700 px-4 py-1.5 rounded-md border border-gray-200 hover:bg-gray-200 transition text-sm font-medium">
                        Delete
                    </button>
                </div>
            </div>

            <!-- Content area with more space and better spacing -->
            <div class="p-6">
                <form id="journal-form" class="space-y-6">
                    <input type="hidden" id="journal-id" name="id"
                        value="{{ journal_entries[0].id if journal_entries }}">

                    <!-- Date information with cleaner layout -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">Date</label>
                            <div id="date-display"
                                class="text-gray-800 font-medium text-base border-b border-gray-200 pb-1 pt-1">
                                {{ journal_entries[0].formatted_date if journal_entries }}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">Day of Week</label>
                            <div id="day_of_week"
                                class="text-gray-800 font-medium text-base border-b border-gray-200 pb-1 pt-1">
                                {{ journal_entries[0].day_of_week if journal_entries }}
                            </div>
                        </div>
                    </div>

                    <!-- Mood rating with simpler design -->
                    <div class="my-8">
                        <label for="rating" class="block text-sm font-medium text-gray-500 mb-2">Mood Rating</label>

                        <div class="flex justify-between mb-2">
                            <span class="text-gray-500">ğŸ˜ Awful</span>
                            <span class="text-gray-500">ğŸ˜Š Excellent</span>
                        </div>

                        <!-- Slider untuk rating -->
                        <input type="range" min="1" max="5"
                            value="{{ journal_entries[0].rating if journal_entries else 3 }}" id="mood-slider"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                            oninput="updateMoodEmoji(this.value)">

                        <!-- Emoji dan input hidden -->
                        <div class="text-center mt-2">
                            <span id="mood-emoji" class="text-5xl">ğŸ˜</span>
                            <input type="hidden" name="rating" id="rating"
                                value="{{ journal_entries[0].rating if journal_entries else 3 }}">
                        </div>
                    </div>

                    <!-- Journal entry with minimalist styling -->
                    <div class="space-y-2">
                        <div class="mb-1">
                            <label for="journal" class="block text-sm font-medium text-gray-500 mb-2">Journal
                                Entry</label>
                            <textarea id="journal" name="journal" rows="8" class="journal-textarea w-full p-3 text-sm border border-gray-200 rounded
                            bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500
                            focus:ring-opacity-50 transition-all duration-300"
                                placeholder="Write your thoughts here...">{{ journal_entries[0].journal if journal_entries }}</textarea>
                        </div>

                        <div class="text-right">
                            <span id="char-count" class="text-xs text-gray-500">0 characters</span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast-container" class="fixed top-4 right-4 z-50"></div>

<script>
    // Mapping rating ke emoji yang lebih friendly
    const moodEmojis = {
        1: 'ğŸ˜',  // Awful
        2: 'â˜¹ï¸',  // Meh
        3: 'ğŸ˜',  // Okay
        4: 'ğŸ™‚',  // Nice
        5: 'ğŸ˜Š'   // Excellent
    };

    function updateMoodEmoji(value) {
        document.getElementById('mood-emoji').textContent = moodEmojis[value];
        document.getElementById('rating').value = value; // Simpan nilai di input hidden
    }

    // Set emoji awal saat halaman dimuat
    document.addEventListener('DOMContentLoaded', function () {
        const moodSlider = document.getElementById('mood-slider');
        updateMoodEmoji(moodSlider.value);
    });

    document.addEventListener('DOMContentLoaded', function () {
        const journalList = document.getElementById('journal-list');
        const journalForm = document.getElementById('journal-form');
        const saveButton = document.getElementById('save-button');
        const deleteButton = document.getElementById('delete-button');
        const journalIdField = document.getElementById('journal-id');
        const ratingInput = document.getElementById('rating');
        const moodEmoji = document.getElementById('mood-emoji');
        const actionButtons = document.getElementById('action-buttons');
        const toastContainer = document.getElementById('toast-container');

        // Ambil elemen textarea dan counter karakter
        const journalTextarea = document.getElementById('journal');
        const charCount = document.getElementById('char-count');

        // Fungsi untuk memperbarui counter karakter
        function updateCharCount() {
            charCount.textContent = `${journalTextarea.value.length} characters`;
        }

        // Jalankan counter saat pengguna mengetik
        journalTextarea.addEventListener('input', updateCharCount);

        // Hide buttons if no entries
        if (!journalIdField.value) {
            actionButtons.classList.add('hidden');
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white px-4 py-2 rounded shadow-lg mb-2`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => {
                    toast.remove();
                }, 500);
            }, 3000);
        }

        // Mapping rating ke emoji
        const moodEmojis = {
            1: 'ğŸ˜',  // Awful
            2: 'â˜¹ï¸',  // Meh
            3: 'ğŸ˜',  // Okay
            4: 'ğŸ™‚',  // Nice
            5: 'ğŸ˜Š'   // Excellent
        };

        // Load entry when clicking on a journal item
        journalList.addEventListener('click', function (e) {
            const item = e.target.closest('.journal-item');
            if (!item) return;

            // Clear all selections
            document.querySelectorAll('.journal-item').forEach(el => {
                el.classList.remove('bg-indigo-50');
            });

            // Mark this item as selected
            item.classList.add('bg-indigo-50');

            // Show action buttons
            actionButtons.classList.remove('hidden');

            // Get entry ID
            const entryId = item.getAttribute('data-id');

            // Fetch entry details
            fetch(`/get_entry/${entryId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Populate form with entry data
                        const entry = data.entry;
                        journalIdField.value = entry.id;

                        // Update text content untuk tanggal
                        document.getElementById('date-display').textContent = entry.formatted_date;
                        document.getElementById('day_of_week').textContent = entry.day_of_week;

                        // Update rating slider, hidden input, dan emoji
                        const moodSlider = document.getElementById('mood-slider');
                        const ratingInput = document.getElementById('rating');
                        const moodEmoji = document.getElementById('mood-emoji');

                        moodSlider.value = entry.rating; // Set slider ke rating entry
                        ratingInput.value = entry.rating; // Simpan rating di input hidden
                        moodEmoji.textContent = moodEmojis[entry.rating]; // Update emoji

                        // Update textarea dengan entry yang baru dipilih
                        journalTextarea.value = entry.journal;

                        // Update counter karakter setelah entry dimuat
                        updateCharCount();
                    } else {
                        console.error('Error fetching entry:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        // Handle save button click
        saveButton.addEventListener('click', function () {
            const entryId = journalIdField.value;
            if (!entryId) return;

            const formData = new FormData();
            formData.append('rating', document.getElementById('rating').value);
            formData.append('journal', document.getElementById('journal').value);

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            // Add update endpoint
            fetch(`/update_entry/${entryId}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Journal updated successfully!');

                        // Update the entry in the list
                        const listItem = document.querySelector(`.journal-item[data-id="${entryId}"]`);
                        if (listItem) {
                            const ratingValue = document.getElementById('rating').value;
                            const emojiEl = listItem.querySelector('.text-2xl');
                            const ratingTextEl = listItem.querySelector('.font-medium');

                            // Perbarui emoji dan teks rating
                            if (emojiEl) {
                                emojiEl.textContent = moodEmojis[ratingValue];
                            }
                            if (ratingTextEl) {
                                const ratingTexts = {
                                    1: 'Awful',
                                    2: 'Meh',
                                    3: 'Okay',
                                    4: 'Nice',
                                    5: 'Excellent'
                                };
                                ratingTextEl.textContent = ratingTexts[ratingValue];
                            }
                        }
                    } else {
                        showToast('Error updating journal', 'error');
                        console.error('Error updating entry:', data.message);
                    }
                })
                .catch(error => {
                    showToast('Error updating journal', 'error');
                    console.error('Error:', error);
                });
        });

        // Handle delete button click
        deleteButton.addEventListener('click', function () {
            const entryId = journalIdField.value;
            if (!entryId) return;

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            if (confirm('Are you sure you want to delete this journal entry?')) {
                fetch(`/delete_entry/${entryId}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Journal deleted successfully!');

                            // Remove entry from list
                            const listItem = document.querySelector(`.journal-item[data-id="${entryId}"]`);
                            if (listItem) {
                                const listItemParent = listItem.parentNode;
                                listItemParent.remove();
                            }

                            // Clear form
                            journalForm.reset();
                            journalIdField.value = '';

                            // Select first entry if available
                            const firstEntry = document.querySelector('.journal-item');
                            if (firstEntry) {
                                firstEntry.click();
                            } else {
                                // If no entries left, hide action buttons
                                actionButtons.classList.add('hidden');
                            }
                        } else {
                            showToast('Error deleting journal', 'error');
                            console.error('Error deleting entry:', data.message);
                        }
                    })
                    .catch(error => {
                        showToast('Error deleting journal', 'error');
                        console.error('Error:', error);
                    });
            }
        });

        // If there's at least one entry, select the first one (newest) by default
        const firstEntry = document.querySelector('.journal-item');
        if (firstEntry) {
            // Form is already populated with the first entry from server-side
            actionButtons.classList.remove('hidden');

            // Perbarui jumlah karakter dari jurnal pertama yang ditampilkan
            updateCharCount();
        }
    });
</script>



{% endblock %}